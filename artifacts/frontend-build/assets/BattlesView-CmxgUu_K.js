import{d as le,k as re,C as ne,o,c as d,e as a,g as Z,J as I,F as M,n as N,t as n,h as m,i as V,s as J,r as _,G as oe}from"./index-BIUjLROW.js";import{C as A,r as de}from"./chart-DaPPa1q0.js";import{u as ce}from"./useChartConfig-CCFcitaf.js";import{u as ve}from"./useKartingAPI-uF34JNNR.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./driverColors-pQD1MuRz.js";const pe={class:"battles-view"},me={class:"battle-selector"},_e={class:"driver-select"},fe=["value"],he={class:"driver-select"},ge=["value"],ke=["disabled"],be={key:0},ye={key:1},Ce={key:0,class:"loading-state"},we={key:1,class:"error-state"},Be={key:2,class:"battle-stats"},We={class:"driver-card left"},De={class:"driver-avatar"},Se={class:"score-badge winner"},Te={class:"battle-info"},Ge={class:"battle-metric"},Le={class:"metric-value"},Ae={class:"battle-metric"},Fe={class:"metric-value"},Ue={class:"battle-metric"},Ee={class:"metric-value"},xe={class:"driver-card right"},Me={class:"driver-avatar"},Ne={class:"score-badge winner"},Ve={key:3,class:"empty-state"},$e={key:4,class:"charts-section"},Re={class:"chart-container"},je={class:"chart-container"},He={class:"chart-container full-width"},Pe={key:5,class:"history-card"},ze={class:"battle-timeline"},Oe={class:"battle-date"},Ze={class:"battle-track"},Ie={class:"battle-times"},Je={class:"driver-name"},Ke={class:"time"},qe={class:"driver-name"},Qe={class:"time"},Xe={class:"battle-gap"},Ye=le({__name:"BattlesView",setup(et){A.register(...de);const{getColor:b}=ce(),{getAllLaps:$,getDriverStats:K,loading:f,error:y}=ve(),l=_(null),r=_(null),h=_([]),v=_({totalBattles:0,driver1Wins:0,driver2Wins:0,avgGap:0,closestGap:0}),C=_([]),F=_(),U=_(),E=_();let B=null,W=null,D=null;async function q(){try{const s=await K();s&&s.length>0&&(h.value=s.map(e=>({id:e.driver_id,name:e.driver_name})),h.value.length>=2&&(l.value=h.value[0].id,r.value=h.value[1].id))}catch(s){console.error("Failed to load drivers:",s)}}function R(){v.value={totalBattles:0,driver1Wins:0,driver2Wins:0,avgGap:0,closestGap:0},C.value=[]}async function j(){if(!l.value||!r.value||l.value===r.value){y.value="Please select two different drivers";return}f.value=!0,y.value="";try{const[s,e]=await Promise.all([$(l.value),$(r.value)]);if(!s||!e)throw new Error("Failed to load lap data");const t=Q(s,e);X(t),C.value=t.sort((i,p)=>new Date(p.date).getTime()-new Date(i.date).getTime()).slice(0,20),await oe(),Y()}catch(s){y.value=s.message||"Failed to load battle data",console.error("Battle load error:",s)}finally{f.value=!1}}function Q(s,e){const t=[],i=G(s,"track_id"),p=G(e,"track_id");return Object.keys(i).filter(c=>p[c]).forEach(c=>{const x=i[c],ae=p[c],z=G(x,"session_id"),O=G(ae,"session_id");Object.keys(z).filter(S=>O[S]).forEach(S=>{const se=z[S],ie=O[S],w=se.reduce((k,T)=>!k||T.lap_time<k.lap_time?T:k),L=ie.reduce((k,T)=>!k||T.lap_time<k.lap_time?T:k);w&&L&&t.push({track_id:c,track_name:w.track_name,session_id:S,date:w.created_at,driver1_time:w.lap_time,driver2_time:L.lap_time,winner:w.lap_time<L.lap_time?l.value:r.value,gap:Math.abs(w.lap_time-L.lap_time)})})}),t}function X(s){if(s.length===0){v.value={totalBattles:0,driver1Wins:0,driver2Wins:0,avgGap:0,closestGap:0};return}const e=s.filter(c=>c.winner===l.value).length,t=s.filter(c=>c.winner===r.value).length,i=s.map(c=>c.gap),p=i.reduce((c,x)=>c+x,0)/i.length,P=Math.min(...i);v.value={totalBattles:s.length,driver1Wins:e,driver2Wins:t,avgGap:p,closestGap:P}}function G(s,e){return s.reduce((t,i)=>{const p=i[e];return t[p]=t[p]||[],t[p].push(i),t},{})}function Y(){if(C.value.length===0)return;B&&B.destroy(),W&&W.destroy(),D&&D.destroy();const s=C.value.slice().reverse();if(F.value){const e=s.map((t,i)=>`Battle ${i+1}`);B=new A(F.value,{type:"line",data:{labels:e,datasets:[{label:l.value?u(l.value):"Driver 1",data:s.map(t=>t.driver1_time),borderColor:b(0),backgroundColor:b(0)+"20",tension:.4},{label:r.value?u(r.value):"Driver 2",data:s.map(t=>t.driver2_time),borderColor:b(1),backgroundColor:b(1)+"20",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!1,ticks:{callback:t=>g(Number(t))}}}}})}if(U.value){const e=s.map(t=>t.gap);W=new A(U.value,{type:"bar",data:{labels:s.map((t,i)=>`Battle ${i+1}`),datasets:[{label:"Time Gap (seconds)",data:e,backgroundColor:e.map(t=>t<1?"#10B981":t<2?"#F59E0B":"#EF4444"),borderColor:e.map(t=>t<1?"#10B981":t<2?"#F59E0B":"#EF4444"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:t=>g(Number(t))}}}}})}if(E.value){const e=ee(s),t=Object.keys(e);D=new A(E.value,{type:"bar",data:{labels:t,datasets:[{label:`${l.value?u(l.value):"Driver 1"} Wins`,data:t.map(i=>e[i].driver1Wins),backgroundColor:b(0)},{label:`${r.value?u(r.value):"Driver 2"} Wins`,data:t.map(i=>e[i].driver2Wins),backgroundColor:b(1)}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}})}}function ee(s){const e={};return s.forEach(t=>{const i=t.track_name;e[i]||(e[i]={driver1Wins:0,driver2Wins:0}),t.winner===l.value?e[i].driver1Wins++:e[i].driver2Wins++}),e}function u(s){var e;return((e=h.value.find(t=>t.id===s))==null?void 0:e.name)||"Unknown"}function H(s){return s.split(" ").map(e=>e[0]).join("").toUpperCase()}function g(s){if(!s)return"0.000";const e=Math.floor(s/60),t=(s%60).toFixed(3);return e>0?`${e}:${t.padStart(6,"0")}`:t}function te(s){return new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}return re(async()=>{await q()}),ne(()=>{B&&B.destroy(),W&&W.destroy(),D&&D.destroy()}),(s,e)=>(o(),d("div",pe,[e[17]||(e[17]=a("header",{class:"page-header"},[a("h1",null,"âš”ï¸ Head-to-Head Battles"),a("p",null,"Compare performance against other drivers")],-1)),a("div",me,[a("div",_e,[e[2]||(e[2]=a("label",null,"Driver 1",-1)),Z(a("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>l.value=t),onChange:R,class:"select-input"},[(o(!0),d(M,null,N(h.value,t=>(o(),d("option",{key:t.id,value:t.id},n(t.name),9,fe))),128))],544),[[I,l.value]])]),e[4]||(e[4]=a("div",{class:"vs-icon"},"âš”ï¸",-1)),a("div",he,[e[3]||(e[3]=a("label",null,"Driver 2",-1)),Z(a("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>r.value=t),onChange:R,class:"select-input"},[(o(!0),d(M,null,N(h.value,t=>(o(),d("option",{key:t.id,value:t.id},n(t.name),9,ge))),128))],544),[[I,r.value]])]),a("button",{onClick:j,disabled:m(f),class:"btn-primary"},[m(f)?(o(),d("span",be,"Loading...")):(o(),d("span",ye,"Compare"))],8,ke)]),m(f)?(o(),d("div",Ce,[...e[5]||(e[5]=[a("div",{class:"spinner"},null,-1),a("p",null,"Analyzing battle data...",-1)])])):m(y)?(o(),d("div",we,[a("p",null,"âŒ "+n(m(y)),1),a("button",{onClick:j,class:"retry-btn"},"Retry")])):v.value.totalBattles>0?(o(),d("div",Be,[a("div",We,[a("div",De,n(l.value?H(u(l.value)):"?"),1),a("h3",null,n(l.value?u(l.value):"Unknown"),1),a("div",Se,n(v.value.driver1Wins),1),e[6]||(e[6]=a("p",{class:"score-label"},"Wins",-1))]),a("div",Te,[a("div",Ge,[e[7]||(e[7]=a("div",{class:"metric-label"},"Total Battles",-1)),a("div",Le,n(v.value.totalBattles),1)]),a("div",Ae,[e[8]||(e[8]=a("div",{class:"metric-label"},"Avg Gap",-1)),a("div",Fe,n(g(v.value.avgGap)),1)]),a("div",Ue,[e[9]||(e[9]=a("div",{class:"metric-label"},"Closest Battle",-1)),a("div",Ee,n(g(v.value.closestGap)),1)])]),a("div",xe,[a("div",Me,n(r.value?H(u(r.value)):"?"),1),a("h3",null,n(r.value?u(r.value):"Unknown"),1),a("div",Ne,n(v.value.driver2Wins),1),e[10]||(e[10]=a("p",{class:"score-label"},"Wins",-1))])])):!m(f)&&!m(y)?(o(),d("div",Ve,[...e[11]||(e[11]=[a("p",null,"âš”ï¸ No battle data available",-1),a("p",{class:"hint"},"Select two different drivers to compare their performance",-1)])])):V("",!0),v.value.totalBattles>0&&!m(f)?(o(),d("div",$e,[a("div",Re,[e[12]||(e[12]=a("h3",null,"ðŸ“Š Lap Time Comparison",-1)),a("canvas",{ref_key:"lapTimeChart",ref:F},null,512)]),a("div",je,[e[13]||(e[13]=a("h3",null,"ðŸŽ¯ Performance Gap",-1)),a("canvas",{ref_key:"gapChart",ref:U},null,512)]),a("div",He,[e[14]||(e[14]=a("h3",null,"ðŸ Track-by-Track Results",-1)),a("canvas",{ref_key:"trackComparisonChart",ref:E},null,512)])])):V("",!0),C.value.length>0?(o(),d("div",Pe,[e[16]||(e[16]=a("h3",null,"ðŸ“œ Battle History",-1)),a("div",ze,[(o(!0),d(M,null,N(C.value.slice(0,10),(t,i)=>(o(),d("div",{key:i,class:"battle-item"},[a("div",Oe,n(te(t.date)),1),a("div",Ze,n(t.track_name),1),a("div",Ie,[a("div",{class:J(["time-box",t.winner===l.value?"winner":""])},[a("span",Je,n(l.value?u(l.value):"Unknown"),1),a("span",Ke,n(g(t.driver1_time)),1)],2),e[15]||(e[15]=a("div",{class:"vs-divider"},"vs",-1)),a("div",{class:J(["time-box",t.winner===r.value?"winner":""])},[a("span",qe,n(r.value?u(r.value):"Unknown"),1),a("span",Qe,n(g(t.driver2_time)),1)],2)]),a("div",Xe," Gap: "+n(g(Math.abs(t.driver1_time-t.driver2_time))),1)]))),128))])])):V("",!0)]))}}),ot=ue(Ye,[["__scopeId","data-v-c55fdd68"]]);export{ot as default};
