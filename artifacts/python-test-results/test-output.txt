============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /opt/hostedtoolcache/Python/3.11.14/x64/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/work/karting/karting/data-importer/scripts
configfile: pytest.ini
testpaths: tests
plugins: cov-7.0.0, mock-3.15.1
collecting ... collected 29 items

tests/test_config.py::TestLoadConfig::test_load_config_from_file PASSED  [  3%]
tests/test_config.py::TestLoadConfig::test_load_config_returns_defaults PASSED [  6%]
tests/test_config.py::TestGetHeatPrice::test_get_heat_price_known_track PASSED [ 10%]
tests/test_config.py::TestGetHeatPrice::test_get_heat_price_unknown_track PASSED [ 13%]
tests/test_config.py::TestGetCostPerLap::test_get_cost_per_lap_known_track PASSED [ 17%]
tests/test_config.py::TestGetCostPerLap::test_get_cost_per_lap_unknown_track PASSED [ 20%]
tests/test_process_karting_sessions.py::TestTimeConversion::test_convert_time_string_to_seconds PASSED [ 24%]
tests/test_process_karting_sessions.py::TestTimeConversion::test_convert_seconds_only_format PASSED [ 27%]
tests/test_process_karting_sessions.py::TestSpeedCalculation::test_calculate_speed_from_distance_and_time FAILED [ 31%]
tests/test_process_karting_sessions.py::TestSpeedCalculation::test_calculate_speed_zero_time_returns_zero FAILED [ 34%]
tests/test_process_karting_sessions.py::TestDuplicateDetection::test_is_duplicate_session_returns_false_for_new FAILED [ 37%]
tests/test_process_karting_sessions.py::TestDuplicateDetection::test_is_duplicate_session_returns_true_for_existing FAILED [ 41%]
tests/test_process_karting_sessions.py::TestSessionNumbering::test_get_session_number_first_of_day FAILED [ 44%]
tests/test_process_karting_sessions.py::TestSessionNumbering::test_get_session_number_increments FAILED [ 48%]
tests/test_process_karting_sessions.py::TestDriverNormalization::test_normalize_driver_name_strips_whitespace FAILED [ 51%]
tests/test_process_karting_sessions.py::TestDriverNormalization::test_normalize_driver_name_handles_aliases FAILED [ 55%]
tests/test_process_karting_sessions.py::TestCSVWriting::test_write_session_to_csv_creates_file FAILED [ 58%]
tests/test_process_karting_sessions.py::TestCSVWriting::test_write_session_appends_to_existing FAILED [ 62%]
tests/test_session_parser.py::TestSessionParser::test_parser_initialization PASSED [ 65%]
tests/test_session_parser.py::TestSessionParser::test_parse_file_with_invalid_path FAILED [ 68%]
tests/test_session_parser.py::TestSessionParser::test_parse_file_detects_eml PASSED [ 72%]
tests/test_session_parser.py::TestSessionParser::test_get_email_body_extracts_content FAILED [ 75%]
tests/test_session_parser.py::TestSessionParser::test_identify_track_from_content FAILED [ 79%]
tests/test_session_parser.py::TestSessionParser::test_convert_to_csv_row_format PASSED [ 82%]
tests/test_session_parser.py::TestBase64Decoding::test_decode_valid_base64 PASSED [ 86%]
tests/test_session_parser.py::TestBase64Decoding::test_decode_base64_with_newlines PASSED [ 89%]
tests/test_session_parser.py::TestLapTimeExtraction::test_extract_lap_time_mm_ss_format PASSED [ 93%]
tests/test_session_parser.py::TestLapTimeExtraction::test_extract_lap_time_ss_mmm_format PASSED [ 96%]
tests/test_session_parser.py::TestLapTimeExtraction::test_extract_multiple_lap_times PASSED [100%]

=================================== FAILURES ===================================
_______ TestSpeedCalculation.test_calculate_speed_from_distance_and_time _______

self = <tests.test_process_karting_sessions.TestSpeedCalculation object at 0x7f1321cba1d0>

    def test_calculate_speed_from_distance_and_time(self):
        """Test speed calculation."""
>       from process_karting_sessions import calculate_speed
E       ImportError: cannot import name 'calculate_speed' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:37: ImportError
_______ TestSpeedCalculation.test_calculate_speed_zero_time_returns_zero _______

self = <tests.test_process_karting_sessions.TestSpeedCalculation object at 0x7f1321cba990>

    def test_calculate_speed_zero_time_returns_zero(self):
        """Test that zero time returns zero speed."""
>       from process_karting_sessions import calculate_speed
E       ImportError: cannot import name 'calculate_speed' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:45: ImportError
____ TestDuplicateDetection.test_is_duplicate_session_returns_false_for_new ____

self = <tests.test_process_karting_sessions.TestDuplicateDetection object at 0x7f1321cbb490>
temp_csv_file = '/tmp/tmp6rvhhaua.csv'

    def test_is_duplicate_session_returns_false_for_new(self, temp_csv_file):
        """Test new session is not duplicate."""
>       from process_karting_sessions import is_duplicate_session
E       ImportError: cannot import name 'is_duplicate_session' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:56: ImportError
__ TestDuplicateDetection.test_is_duplicate_session_returns_true_for_existing __

self = <tests.test_process_karting_sessions.TestDuplicateDetection object at 0x7f1321cb82d0>
temp_csv_file = '/tmp/tmphorr4nt1.csv'

    def test_is_duplicate_session_returns_true_for_existing(self, temp_csv_file):
        """Test existing session is detected as duplicate."""
>       from process_karting_sessions import is_duplicate_session
E       ImportError: cannot import name 'is_duplicate_session' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:69: ImportError
__________ TestSessionNumbering.test_get_session_number_first_of_day ___________

self = <tests.test_process_karting_sessions.TestSessionNumbering object at 0x7f1321cb8a90>
temp_csv_file = '/tmp/tmp5h32cga9.csv'

    def test_get_session_number_first_of_day(self, temp_csv_file):
        """Test first session of day gets number 1."""
>       from process_karting_sessions import get_session_number
E       ImportError: cannot import name 'get_session_number' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:85: ImportError
___________ TestSessionNumbering.test_get_session_number_increments ____________

self = <tests.test_process_karting_sessions.TestSessionNumbering object at 0x7f1321cb8e10>
temp_csv_file = '/tmp/tmpaqukvuud.csv'

    def test_get_session_number_increments(self, temp_csv_file):
        """Test session number increments for same day/track."""
>       from process_karting_sessions import get_session_number
E       ImportError: cannot import name 'get_session_number' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:96: ImportError
_____ TestDriverNormalization.test_normalize_driver_name_strips_whitespace _____

self = <tests.test_process_karting_sessions.TestDriverNormalization object at 0x7f1321cb98d0>

    def test_normalize_driver_name_strips_whitespace(self):
        """Test driver names are trimmed."""
        from process_karting_sessions import normalize_driver_name
    
>       result = normalize_driver_name("  Driver 1  ")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: normalize_driver_name() missing 1 required positional argument: 'track_name'

tests/test_process_karting_sessions.py:115: TypeError
______ TestDriverNormalization.test_normalize_driver_name_handles_aliases ______

self = <tests.test_process_karting_sessions.TestDriverNormalization object at 0x7f1322cbc210>

    def test_normalize_driver_name_handles_aliases(self):
        """Test driver aliases are resolved."""
        from process_karting_sessions import normalize_driver_name
    
        # This depends on configured aliases
>       result = normalize_driver_name("Some Alias")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: normalize_driver_name() missing 1 required positional argument: 'track_name'

tests/test_process_karting_sessions.py:123: TypeError
____________ TestCSVWriting.test_write_session_to_csv_creates_file _____________

self = <tests.test_process_karting_sessions.TestCSVWriting object at 0x7f1321e082d0>

    def test_write_session_to_csv_creates_file(self):
        """Test writing session creates CSV file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
            temp_path = f.name
    
        try:
>           from process_karting_sessions import write_session_to_csv
E           ImportError: cannot import name 'write_session_to_csv' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:137: ImportError
____________ TestCSVWriting.test_write_session_appends_to_existing _____________

self = <tests.test_process_karting_sessions.TestCSVWriting object at 0x7f1321e0ba50>
temp_csv_file = '/tmp/tmpfthhm5lp.csv'

    def test_write_session_appends_to_existing(self, temp_csv_file):
        """Test writing session appends to existing file."""
>       from process_karting_sessions import write_session_to_csv
E       ImportError: cannot import name 'write_session_to_csv' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)

tests/test_process_karting_sessions.py:159: ImportError
_____________ TestSessionParser.test_parse_file_with_invalid_path ______________

self = <tests.test_session_parser.TestSessionParser object at 0x7f1321cfd1d0>
parser = <session_parser.SessionParser object at 0x7f13219f9850>

    def test_parse_file_with_invalid_path(self, parser):
        """Test parsing non-existent file returns None or raises."""
>       result = parser.parse_file("/nonexistent/file.eml")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_session_parser.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <session_parser.SessionParser object at 0x7f13219f9850>
file_path = PosixPath('/nonexistent/file.eml')

    def parse_file(self, file_path: str) -> Dict:
        """
        Main entry point to parse any supported file type
        Returns a dictionary with session data
        """
        file_path = Path(file_path)
    
        if not file_path.exists():
>           raise FileNotFoundError(f"File not found: {file_path}")
E           FileNotFoundError: File not found: /nonexistent/file.eml

session_parser.py:40: FileNotFoundError
---------------------------- Captured stdout setup -----------------------------
Warning: Tracks database not found at tracks.json
____________ TestSessionParser.test_get_email_body_extracts_content ____________

self = <tests.test_session_parser.TestSessionParser object at 0x7f1321cfc510>
parser = <session_parser.SessionParser object at 0x7f132191d3d0>

    def test_get_email_body_extracts_content(self, parser):
        """Test email body extraction from multipart message."""
        msg = EmailMessage()
        msg['Subject'] = 'Test'
        msg.set_content('Plain text content')
        msg.add_alternative('<html><body>HTML content</body></html>', subtype='html')
    
>       body = parser.get_email_body(msg)
               ^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'SessionParser' object has no attribute 'get_email_body'

tests/test_session_parser.py:45: AttributeError
---------------------------- Captured stdout setup -----------------------------
Warning: Tracks database not found at tracks.json
______________ TestSessionParser.test_identify_track_from_content ______________

self = <tests.test_session_parser.TestSessionParser object at 0x7f1321cfd250>
parser = <session_parser.SessionParser object at 0x7f13219ec750>

    def test_identify_track_from_content(self, parser):
        """Test track identification from email content."""
        content = "Results from De Voltage karting session"
>       track = parser.identify_track(content)
                ^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'SessionParser' object has no attribute 'identify_track'

tests/test_session_parser.py:52: AttributeError
---------------------------- Captured stdout setup -----------------------------
Warning: Tracks database not found at tracks.json
- generated xml file: /home/runner/work/karting/karting/data-importer/scripts/test-results.xml -
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.11.14-final-0 _______________

Name                                     Stmts   Miss  Cover   Missing
----------------------------------------------------------------------
add_session.py                             152    152     0%   6-251
config.py                                   49      6    88%   23-24, 140-143, 152
process_karting_sessions.py                771    735     5%   43-58, 62-70, 84-86, 98-104, 108-316, 320-418, 422-788, 792-802, 806-836, 841-887, 891-981, 985-1142, 1146-1277, 1281-1344, 1347-1358
remove_console_logs.py                      37     37     0%   1-71
run_processing.py                           14     14     0%   5-22
session_parser.py                          214    150    30%   26-27, 45-51, 67, 69, 71, 78-90, 94-146, 150-201, 205-216, 220-240, 244-255, 259, 279, 284, 294-295, 298-301, 311, 313, 315, 317, 319, 321, 323, 332-411, 416-429
tests/__init__.py                            0      0   100%
tests/conftest.py                           32      3    91%   33, 50, 93
tests/test_config.py                        45      0   100%
tests/test_process_karting_sessions.py      92     46    50%   40-41, 47-48, 59-65, 71-77, 87-92, 98-105, 116, 124-125, 139-152, 162-179
tests/test_session_parser.py                76      6    92%   30, 46-47, 54, 67-68
----------------------------------------------------------------------
TOTAL                                     1482   1149    22%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_process_karting_sessions.py::TestSpeedCalculation::test_calculate_speed_from_distance_and_time - ImportError: cannot import name 'calculate_speed' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestSpeedCalculation::test_calculate_speed_zero_time_returns_zero - ImportError: cannot import name 'calculate_speed' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestDuplicateDetection::test_is_duplicate_session_returns_false_for_new - ImportError: cannot import name 'is_duplicate_session' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestDuplicateDetection::test_is_duplicate_session_returns_true_for_existing - ImportError: cannot import name 'is_duplicate_session' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestSessionNumbering::test_get_session_number_first_of_day - ImportError: cannot import name 'get_session_number' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestSessionNumbering::test_get_session_number_increments - ImportError: cannot import name 'get_session_number' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestDriverNormalization::test_normalize_driver_name_strips_whitespace - TypeError: normalize_driver_name() missing 1 required positional argument: 'track_name'
FAILED tests/test_process_karting_sessions.py::TestDriverNormalization::test_normalize_driver_name_handles_aliases - TypeError: normalize_driver_name() missing 1 required positional argument: 'track_name'
FAILED tests/test_process_karting_sessions.py::TestCSVWriting::test_write_session_to_csv_creates_file - ImportError: cannot import name 'write_session_to_csv' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_process_karting_sessions.py::TestCSVWriting::test_write_session_appends_to_existing - ImportError: cannot import name 'write_session_to_csv' from 'process_karting_sessions' (/home/runner/work/karting/karting/data-importer/scripts/process_karting_sessions.py)
FAILED tests/test_session_parser.py::TestSessionParser::test_parse_file_with_invalid_path - FileNotFoundError: File not found: /nonexistent/file.eml
FAILED tests/test_session_parser.py::TestSessionParser::test_get_email_body_extracts_content - AttributeError: 'SessionParser' object has no attribute 'get_email_body'
FAILED tests/test_session_parser.py::TestSessionParser::test_identify_track_from_content - AttributeError: 'SessionParser' object has no attribute 'identify_track'
======================== 13 failed, 16 passed in 0.74s =========================
