name: üöÄ Auto Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì¶ Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: üî® Build Frontend
      run: |
        cd portal/frontend
        rm -f package-lock.json
        npm install --force
        VITE_API_BASE_URL=https://solyx.gg/karting/api/public/api npm run build
    
    - name: üêò Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    
    - name: üìö Install Backend
      run: |
        cd portal/backend
        composer install --no-dev --optimize-autoloader
    
    - name: üìÇ Package
      run: |
        mkdir deploy
        cp -r portal/frontend/dist/* deploy/
        mkdir deploy/api
        cp -r portal/backend/* deploy/api/
        rm -rf deploy/api/.env deploy/api/.git* deploy/api/tests
        
        # Create setup script for manual run
        cat > deploy/api/setup.sh << 'SETUPEOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        
        # Find PHP
        PHP_BIN=$(which php82 2>/dev/null || which php 2>/dev/null || echo "php")
        echo "Using PHP: $PHP_BIN"
        
        # Create .env if not exists
        if [ ! -f .env ]; then
          echo "Creating .env file..."
          cat > .env << 'EOF'
        APP_NAME="Karting Portal"
        APP_ENV=production
        APP_KEY=CHANGE_ME
        APP_DEBUG=false
        APP_URL=https://yourdomain.com/karting
        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=your_database
        DB_USERNAME=your_user
        DB_PASSWORD=your_password
        SESSION_DRIVER=database
        CACHE_STORE=database
        SANCTUM_STATEFUL_DOMAINS=yourdomain.com
        EOF
          echo "‚ö†Ô∏è  EDIT .env WITH YOUR DATABASE CREDENTIALS!"
        fi
        
        # Set permissions
        chmod 644 .env
        chmod -R 755 storage bootstrap/cache 2>/dev/null || true
        
        # Run migrations
        echo "Running migrations..."
        $PHP_BIN artisan migrate --force
        
        echo "Caching config..."
        $PHP_BIN artisan config:cache
        $PHP_BIN artisan route:cache
        
        echo "‚úÖ Setup complete!"
        SETUPEOF
        
        chmod +x deploy/api/setup.sh
    
    - name: üöÄ Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: /public_html/karting/
    
    - name: ‚öôÔ∏è Setup & Migrate
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 21098
        script: |
          cd ~/public_html/karting/api || exit 1
          
          # Find PHP 8.2+ (Namecheap specific paths)
          if [ -f /opt/cpanel/ea-php82/root/usr/bin/php ]; then
            PHP_BIN=/opt/cpanel/ea-php82/root/usr/bin/php
          elif [ -f /usr/local/bin/ea-php82 ]; then
            PHP_BIN=/usr/local/bin/ea-php82
          elif command -v php82 &> /dev/null; then
            PHP_BIN=php82
          else
            PHP_BIN=php
          fi
          
          echo "Using PHP: $PHP_BIN"
          $PHP_BIN -v
          
          # Create .env (with trimmed values)
          cat > .env << EOF
          APP_NAME="Karting Portal"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=3306
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SESSION_DRIVER=database
          CACHE_STORE=database
          SANCTUM_STATEFUL_DOMAINS=${{ secrets.SANCTUM_DOMAINS }}
          EOF
          
          # Remove any trailing whitespace from .env
          sed -i 's/[[:space:]]*$//' .env
          
          chmod 644 .env
          chmod -R 755 storage bootstrap/cache 2>/dev/null || true
          
          # Debug: Show credentials (password redacted)
          echo "=== Database Configuration ==="
          grep "^DB_" .env | grep -v "DB_PASSWORD"
          echo "DB_PASSWORD: [REDACTED - Length: $(grep '^DB_PASSWORD=' .env | cut -d'=' -f2 | wc -c) chars]"
          echo "=============================="
          
          # Test database connection first
          echo "Testing database connection..."
          $PHP_BIN artisan db:show || echo "‚ö†Ô∏è  Database connection failed - check credentials"
          
          $PHP_BIN artisan migrate --force || echo "‚ö†Ô∏è  Migration failed"
          $PHP_BIN artisan db:seed --force || echo "‚ö†Ô∏è  Seeding failed"
          $PHP_BIN artisan config:cache
          $PHP_BIN artisan route:cache
          
          echo "‚úÖ Setup complete!"
    
    - name: ‚úÖ Deployment Complete
      run: echo "üéâ Fully automated deployment complete!"

