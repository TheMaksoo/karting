name: ðŸš€ Auto Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ðŸ”¨ Build Frontend
      run: |
        cd portal/frontend
        rm -f package-lock.json
        npm install --force
        npm run build
    
    - name: ðŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    
    - name: ðŸ“š Install Backend
      run: |
        cd portal/backend
        composer install --no-dev --optimize-autoloader
    
    - name: ðŸ“‚ Package
      run: |
        mkdir deploy
        cp -r portal/frontend/dist/* deploy/
        mkdir deploy/api
        cp -r portal/backend/* deploy/api/
        rm -rf deploy/api/.env deploy/api/.git* deploy/api/tests
    
    - name: ðŸš€ Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: /public_html/karting/
    
    - name: âš™ï¸ Setup & Migrate
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        script: |
          cd ~/public_html/karting/api
          
          cat > .env << EOF
          APP_NAME="Karting Portal"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=3306
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SESSION_DRIVER=database
          CACHE_STORE=database
          SANCTUM_STATEFUL_DOMAINS=${{ secrets.SANCTUM_DOMAINS }}
          EOF
          
          chmod 644 .env
          chmod -R 755 storage bootstrap/cache
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan storage:link || true
          
          echo "âœ… Deployed!"

