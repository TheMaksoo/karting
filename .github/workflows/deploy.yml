name: ğŸš€ Auto-Deploy to Namecheap

# âš¡ PLUG & PLAY DEPLOYMENT
# Just set 4 secrets in GitHub and push - everything else is automatic!
#
# Required GitHub Secrets (Settings â†’ Secrets â†’ Actions):
#   1. FTP_PASSWORD    - Your cPanel password
#   2. DB_PASSWORD     - Your MySQL password  
#   3. DOMAIN          - yourdomain.com (optional, defaults to yourdomain.com)
#   4. FTP_USERNAME    - Your cPanel username (optional, defaults to your_cpanel_username)
#
# Everything else auto-generates on first deploy!

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      
      - name: ğŸ“¦ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql
          tools: composer:v2
      
      - name: ğŸ² Auto-Generate Secrets
        id: gen
        working-directory: portal/backend
        run: |
          # Auto-generate APP_KEY if not in secrets
          if [ -z "${{ secrets.LARAVEL_APP_KEY }}" ]; then
            APP_KEY=$(php artisan key:generate --show)
            echo "Generated new APP_KEY"
          else
            APP_KEY="${{ secrets.LARAVEL_APP_KEY }}"
            echo "Using existing APP_KEY from secrets"
          fi
          echo "app_key=$APP_KEY" >> $GITHUB_OUTPUT
          
          # Auto-generate JWT_SECRET if not in secrets
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then
            JWT_SECRET=$(openssl rand -base64 64 | tr -d '\n')
            echo "Generated new JWT_SECRET"
          else
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            echo "Using existing JWT_SECRET from secrets"
          fi
          echo "jwt_secret=$JWT_SECRET" >> $GITHUB_OUTPUT
          
          # Set domain (auto-detect or use secret)
          DOMAIN="${{ secrets.DOMAIN }}"
          if [ -z "$DOMAIN" ]; then
            DOMAIN="yourdomain.com"
            echo "âš ï¸  Using default domain: $DOMAIN"
            echo "ğŸ’¡ Add DOMAIN secret to use your actual domain"
          fi
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          
          # Set FTP username
          FTP_USER="${{ secrets.FTP_USERNAME }}"
          if [ -z "$FTP_USER" ]; then
            FTP_USER="your_cpanel_username"
            echo "âš ï¸  Using default FTP username"
            echo "ğŸ’¡ Add FTP_USERNAME secret to use your actual username"
          fi
          echo "ftp_user=$FTP_USER" >> $GITHUB_OUTPUT
          
          # Set FTP server
          FTP_SERVER="${{ secrets.FTP_SERVER }}"
          if [ -z "$FTP_SERVER" ]; then
            FTP_SERVER="ftp.$DOMAIN"
            echo "Auto-configured FTP server: $FTP_SERVER"
          fi
          echo "ftp_server=$FTP_SERVER" >> $GITHUB_OUTPUT
          
          # Database defaults
          echo "db_host=${{ secrets.DB_HOST || 'localhost' }}" >> $GITHUB_OUTPUT
          echo "db_port=${{ secrets.DB_PORT || '3306' }}" >> $GITHUB_OUTPUT
          echo "db_name=${{ secrets.DB_DATABASE || 'karting_db' }}" >> $GITHUB_OUTPUT
          echo "db_user=${{ secrets.DB_USERNAME || 'karting_user' }}" >> $GITHUB_OUTPUT
      
      - name: ğŸ”¨ Build Frontend
        working-directory: portal/frontend
        run: |
          npm ci --prefer-offline
          
          # Auto-create production config
          cat > .env.production << EOF
          VITE_API_BASE_URL=https://${{ steps.gen.outputs.domain }}/karting/api/api
          VITE_APP_NAME=Karting Portal
          VITE_APP_ENV=production
          EOF
          
          npm run build
      
      - name: ğŸ”§ Build Backend
        working-directory: portal/backend
        run: composer install --no-dev --optimize-autoloader --no-interaction
      
      - name: ğŸ“¦ Create Deployment Package
        run: |
          mkdir -p deploy
          
          # Copy frontend
          cp -r portal/frontend/dist/* deploy/
          
          # Copy backend
          mkdir -p deploy/api
          cp -r portal/backend/* deploy/api/
          rm -rf deploy/api/{tests,node_modules,.env,.env.example}
          
          # Auto-create .env
          cat > deploy/api/.env << 'EOF'
          APP_NAME="Karting Portal"
          APP_ENV=production
          APP_KEY=${{ steps.gen.outputs.app_key }}
          APP_DEBUG=false
          APP_URL=https://${{ steps.gen.outputs.domain }}/karting
          
          LOG_CHANNEL=stack
          LOG_LEVEL=error
          
          DB_CONNECTION=mysql
          DB_HOST=${{ steps.gen.outputs.db_host }}
          DB_PORT=${{ steps.gen.outputs.db_port }}
          DB_DATABASE=${{ steps.gen.outputs.db_name }}
          DB_USERNAME=${{ steps.gen.outputs.db_user }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          CACHE_DRIVER=file
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          
          JWT_SECRET=${{ steps.gen.outputs.jwt_secret }}
          JWT_TTL=60
          JWT_REFRESH_TTL=20160
          EOF
          
          # Create root .htaccess
          cat > deploy/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteBase /karting/
              
              # API routing
              RewriteCond %{REQUEST_URI} ^/karting/api/
              RewriteRule ^api/(.*)$ api/public/index.php [L,QSA]
              
              # Static files
              RewriteCond %{REQUEST_FILENAME} -f
              RewriteRule ^ - [L]
              
              # Vue app
              RewriteRule ^ index.html [L]
          </IfModule>
          EOF
          
          # Create Laravel .htaccess
          cat > deploy/api/public/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteCond %{REQUEST_FILENAME} !-d
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteRule ^ index.php [L]
          </IfModule>
          EOF
      
      - name: ğŸš€ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.gen.outputs.ftp_server }}
          username: ${{ steps.gen.outputs.ftp_user }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /public_html/karting/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/node_modules/**
            **/tests/**
            **/*.md
      
      - name: ğŸ”§ Configure Server (SSH - Optional)
        if: secrets.SSH_PASSWORD != ''
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST || steps.gen.outputs.ftp_server }}
          username: ${{ secrets.SSH_USERNAME || steps.gen.outputs.ftp_user }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || '21098' }}
          script: |
            cd ~/public_html/karting/api
            chmod -R 755 storage bootstrap/cache
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            echo "âœ… Server configured!"
      
      - name: ğŸ‰ Success
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Your app is live at:"
          echo "   https://${{ steps.gen.outputs.domain }}/karting/"
          echo ""
          echo "ğŸ“ First-time setup:"
          echo "   SSH to server and run:"
          echo "   cd ~/public_html/karting/api"
          echo "   php artisan migrate --force"
          echo ""
          
          if [ -z "${{ secrets.LARAVEL_APP_KEY }}" ] || [ -z "${{ secrets.JWT_SECRET }}" ]; then
            echo "âš ï¸  Generated new secrets. Add these to GitHub Secrets:"
            echo ""
            if [ -z "${{ secrets.LARAVEL_APP_KEY }}" ]; then
              echo "   LARAVEL_APP_KEY=${{ steps.gen.outputs.app_key }}"
            fi
            if [ -z "${{ secrets.JWT_SECRET }}" ]; then
              echo "   JWT_SECRET=${{ steps.gen.outputs.jwt_secret }}"
            fi
            echo ""
          fi
