# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    ğŸï¸ KARTING DASHBOARD - UNIFIED PIPELINE                  â•‘
# â•‘                                                                              â•‘
# â•‘  All-in-one CI/CD with automatic fixes and deployment                       â•‘
# â•‘                                                                              â•‘
# â•‘  WORKFLOW GRAPH:                                                             â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘
# â•‘  â”‚ Lint    â”‚   â”‚ Lint    â”‚   â”‚ Lint    â”‚                                    â•‘
# â•‘  â”‚   PHP   â”‚   â”‚   TS    â”‚   â”‚ ESLint  â”‚                                    â•‘
# â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â•‘
# â•‘       â”‚             â”‚             â”‚                                          â•‘
# â•‘       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â•‘
# â•‘              â–¼                                                               â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â•‘
# â•‘  â”‚              TESTS                       â”‚                                â•‘
# â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                â•‘
# â•‘  â”‚  â”‚ Backend â”‚  â”‚Frontend â”‚  â”‚ Python  â”‚  â”‚                                â•‘
# â•‘  â”‚  â”‚  Pest   â”‚  â”‚ Vitest  â”‚  â”‚ Pytest  â”‚  â”‚                                â•‘
# â•‘  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚                                â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â•‘
# â•‘              â”‚                                                               â•‘
# â•‘              â–¼                                                               â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â•‘
# â•‘  â”‚   SonarCloud    â”‚â”€â”€â”€â”€â–¶â”‚  Quality Gate   â”‚                                â•‘
# â•‘  â”‚    Analysis     â”‚     â”‚    (Pass?)      â”‚                                â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â•‘
# â•‘                                   â”‚                                          â•‘
# â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â•‘
# â•‘              â–¼                    â”‚                    â–¼                    â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
# â•‘  â”‚   âŒ Auto-Fix   â”‚              â”‚       â”‚   âœ… Deploy     â”‚               â•‘
# â•‘  â”‚  (on failure)   â”‚              â”‚       â”‚  (on success)   â”‚               â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
# â•‘           â”‚                       â”‚                                          â•‘
# â•‘           â–¼                       â”‚                                          â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                          â•‘
# â•‘  â”‚  Push Fixes &   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â•‘
# â•‘  â”‚   Re-trigger    â”‚                                                         â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ”‘ REQUIRED SECRETS:
#   - SONAR_TOKEN: SonarCloud authentication
#   - CODECOV_TOKEN: Codecov upload token
#   - FTP_SERVER, FTP_USERNAME, FTP_PASSWORD: Namecheap FTP
#   - SSH_HOST, SSH_USERNAME, SSH_PRIVATE_KEY: Namecheap SSH (port 21098)
#   - APP_KEY, APP_URL, DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD
#   - SANCTUM_DOMAINS: Your domain for auth

name: ğŸï¸ Karting Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  MAX_FIX_ATTEMPTS: 5

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” STAGE 1: LINTING (runs in parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  lint-php:
    name: ğŸ˜ PHP Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/backend
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
      - run: composer install --prefer-dist --no-progress
      - run: vendor/bin/pint --test

  lint-typescript:
    name: ğŸ“˜ TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run type-check

  lint-eslint:
    name: ğŸŸ¨ ESLint Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run lint

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª STAGE 2: TESTS (runs after linting passes)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test-backend:
    name: ğŸ˜ Backend Tests
    runs-on: ubuntu-latest
    needs: [lint-php]
    defaults:
      run:
        working-directory: portal/backend
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_mysql, mbstring, xml, curl, zip
          coverage: xdebug
      - run: composer install --prefer-dist --no-progress
      - run: cp .env.example .env && php artisan key:generate
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -u root -ppassword --silent && exit 0 || sleep 2
          done
          exit 1
      - name: Run Tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          php artisan migrate --force
          mkdir -p coverage
          vendor/bin/pest --coverage --coverage-clover=coverage/clover.xml
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./portal/backend/coverage/clover.xml
          flags: backend
      - uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: portal/backend/coverage/

  test-frontend:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    needs: [lint-typescript, lint-eslint]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run test:coverage -- --run
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./portal/frontend/coverage/lcov.info
          flags: frontend
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: portal/frontend/coverage/

  test-python:
    name: ğŸ Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: data-importer/scripts
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install pytest pytest-cov requests python-dateutil
      - run: python -m pytest --cov=. --cov-report=xml:coverage.xml -v || true
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./data-importer/scripts/coverage.xml
          flags: python
      - uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: data-importer/scripts/coverage.xml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”¨ STAGE 3: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build-frontend:
    name: ğŸ”¨ Build Frontend
    runs-on: ubuntu-latest
    needs: [test-frontend]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run build
        env:
          VITE_API_BASE_URL: https://solyx.gg/karting/api/public/api
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: portal/frontend/dist/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š STAGE 4: SONARCLOUD ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  sonarcloud:
    name: ğŸ“Š SonarCloud
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-python]
    if: always() && !cancelled()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: portal/backend/coverage/
        continue-on-error: true
      - uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: portal/frontend/coverage/
        continue-on-error: true
      - uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: data-importer/scripts/
        continue-on-error: true
      - name: Verify Coverage Files
        run: |
          echo "### ğŸ“Š Coverage Files" >> $GITHUB_STEP_SUMMARY
          [ -f portal/backend/coverage/clover.xml ] && echo "âœ… PHP Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ PHP Coverage missing" >> $GITHUB_STEP_SUMMARY
          [ -f portal/frontend/coverage/lcov.info ] && echo "âœ… Frontend Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ Frontend Coverage missing" >> $GITHUB_STEP_SUMMARY
          [ -f data-importer/scripts/coverage.xml ] && echo "âœ… Python Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ Python Coverage missing" >> $GITHUB_STEP_SUMMARY
      - uses: SonarSource/sonarqube-scan-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: -Dsonar.host.url=https://sonarcloud.io

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âœ… STAGE 5: QUALITY GATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [lint-php, lint-typescript, lint-eslint, test-backend, test-frontend, build-frontend, sonarcloud]
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check Results
        id: check
        run: |
          FAILED=0
          
          # Check each job
          [ "${{ needs.lint-php.result }}" != "success" ] && FAILED=1
          [ "${{ needs.lint-typescript.result }}" != "success" ] && FAILED=1
          [ "${{ needs.lint-eslint.result }}" != "success" ] && FAILED=1
          [ "${{ needs.test-backend.result }}" != "success" ] && FAILED=1
          [ "${{ needs.test-frontend.result }}" != "success" ] && FAILED=1
          [ "${{ needs.build-frontend.result }}" != "success" ] && FAILED=1
          
          if [ $FAILED -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "### âœ… All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "### âŒ Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Summary table
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Lint | ${{ needs.lint-php.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.lint-typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.lint-eslint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.test-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.test-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”§ STAGE 6A: AUTO-FIX (on failure)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  auto-fix:
    name: ğŸ”§ Auto-Fix
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: needs.quality-gate.outputs.passed == 'false' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check Fix Attempts
        id: attempts
        run: |
          COUNT=$(git log --oneline -20 | grep -c "ğŸ”§ Auto-fix" || echo 0)
          echo "attempts=$COUNT" >> $GITHUB_OUTPUT
          if [ $COUNT -ge ${{ env.MAX_FIX_ATTEMPTS }} ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Max fix attempts (${{ env.MAX_FIX_ATTEMPTS }}) reached" >> $GITHUB_STEP_SUMMARY
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Tools
        if: steps.attempts.outputs.skip != 'true'
        run: |
          # PHP
          sudo apt-get update && sudo apt-get install -y php8.2-cli php8.2-xml php8.2-curl
          cd portal/backend && composer install --quiet
          
          # Node
          cd ../frontend && npm ci --silent
          
          # Python
          pip install black autopep8 --quiet

      - name: Apply Fixes
        if: steps.attempts.outputs.skip != 'true'
        id: fix
        run: |
          FIXED=false
          
          # PHP - Laravel Pint
          echo "ğŸ”§ Running PHP Pint..."
          cd portal/backend
          vendor/bin/pint --quiet 2>/dev/null || true
          cd ../..
          
          # TypeScript/Vue - ESLint
          echo "ğŸ”§ Running ESLint fix..."
          cd portal/frontend
          npx eslint --fix "src/**/*.{ts,vue}" 2>/dev/null || true
          cd ../..
          
          # Python - Black
          echo "ğŸ”§ Running Black..."
          cd data-importer/scripts
          black . --quiet 2>/dev/null || true
          autopep8 --in-place --recursive . 2>/dev/null || true
          cd ../..
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit & Push Fixes
        if: steps.fix.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ğŸ”§ Auto-fix: code style corrections [skip ci]"
          git push
          echo "### âœ… Fixes Applied" >> $GITHUB_STEP_SUMMARY
          echo "Auto-fix committed and pushed. Pipeline will re-run." >> $GITHUB_STEP_SUMMARY

      - name: Create Issue (Max Attempts)
        if: steps.attempts.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            if (!issues.data.find(i => i.title.includes('CI Failed'))) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”´ CI Failed - Manual Fix Required',
                body: `Auto-fix attempts exhausted. Please fix manually.\n\nRun: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
                labels: ['ci-failure', 'bug']
              });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ STAGE 6B: DEPLOY (on success, main branch only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gate, build-frontend]
    if: needs.quality-gate.outputs.passed == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: portal/frontend/dist/

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Prepare Backend
        run: |
          cd portal/backend
          composer install --no-dev --optimize-autoloader

      - name: Package for Deploy
        run: |
          mkdir deploy
          cp -r portal/frontend/dist/* deploy/
          [ -f portal/frontend/.htaccess ] && cp portal/frontend/.htaccess deploy/
          mkdir deploy/api
          cp -r portal/backend/* deploy/api/
          rm -rf deploy/api/.env deploy/api/.git* deploy/api/tests

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /public_html/karting/

      - name: Run Migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 21098
          script: |
            cd ~/public_html/karting/api
            
            # Find PHP 8.2
            PHP_BIN=$(command -v php82 || command -v php || echo "php")
            
            # Create .env
            cat > .env << EOF
            APP_NAME="Karting Portal"
            APP_ENV=production
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL }}
            DB_CONNECTION=mysql
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=3306
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            SESSION_DRIVER=database
            CACHE_STORE=database
            SANCTUM_STATEFUL_DOMAINS=${{ secrets.SANCTUM_DOMAINS }}
            EOF
            
            chmod 644 .env
            chmod -R 755 storage bootstrap/cache 2>/dev/null || true
            
            $PHP_BIN artisan migrate --force
            $PHP_BIN artisan config:cache
            $PHP_BIN artisan route:cache
            
            echo "âœ… Deployment complete!"

      - name: Success Summary
        run: |
          echo "### ğŸ‰ Deployed to Production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ secrets.APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Migrations and caching completed successfully." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ‰ STAGE 7: CLOSE ISSUES ON SUCCESS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  close-issues:
    name: ğŸ‰ Close CI Issues
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: needs.quality-gate.outputs.passed == 'true'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'ğŸ‰ CI Pipeline passed! Closing automatically.'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
