# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    ğŸï¸ KARTING DASHBOARD - UNIFIED PIPELINE                  â•‘
# â•‘                                                                              â•‘
# â•‘  CORRECT FLOW:                                                               â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚                           STAGE 1: LINT                                 â”‚ â•‘
# â•‘  â”‚         PHP Lint â”€â”€â”¬â”€â”€ TypeScript â”€â”€â”¬â”€â”€ ESLint â”€â”€â”¬â”€â”€ Python            â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•‘                                    â”‚                                         â•‘
# â•‘                                    â–¼                                         â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚                          STAGE 2: TEST                                  â”‚ â•‘
# â•‘  â”‚              Backend â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ Frontend â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ Python        â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•‘                                    â”‚                                         â•‘
# â•‘                                    â–¼                                         â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚                   STAGE 3: BUILD + SONARCLOUD                           â”‚ â•‘
# â•‘  â”‚                   Frontend Build â”€â”€â”€â”€â”€â”€ SonarCloud Analysis             â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•‘                                    â”‚                                         â•‘
# â•‘                                    â–¼                                         â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚                        STAGE 4: QUALITY GATE                            â”‚ â•‘
# â•‘  â”‚                      Check if all stages passed                         â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•‘                               â”‚                                              â•‘
# â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â•‘
# â•‘              â”‚                                 â”‚                            â•‘
# â•‘              â–¼ (FAILED)                        â–¼ (PASSED)                   â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â•‘
# â•‘  â”‚   ğŸ”§ AUTO-FIX       â”‚            â”‚   ğŸš€ DEPLOY         â”‚                 â•‘
# â•‘  â”‚   Apply formatters  â”‚            â”‚   (main only)       â”‚                 â•‘
# â•‘  â”‚   Push & re-trigger â”‚            â”‚                     â”‚                 â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â•‘
# â•‘             â”‚                                  â”‚                            â•‘
# â•‘             â–¼                                  â–¼                            â•‘
# â•‘    Re-runs entire pipeline           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â•‘
# â•‘    from start                        â”‚  ğŸ‰ CLOSE ISSUES    â”‚                â•‘
# â•‘                                      â”‚  (after deploy)     â”‚                â•‘
# â•‘                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ”‘ REQUIRED SECRETS:
#   - SONAR_TOKEN: SonarCloud authentication
#   - CODECOV_TOKEN: Codecov upload token
#   - FTP_SERVER, FTP_USERNAME, FTP_PASSWORD: Namecheap FTP
#   - SSH_HOST, SSH_USERNAME, SSH_PRIVATE_KEY: Namecheap SSH (port 21098)
#   - APP_KEY, APP_URL, DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD
#   - SANCTUM_DOMAINS: Your domain for auth

name: ğŸï¸ Karting Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  MAX_FIX_ATTEMPTS: 5

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” STAGE 1: LINTING (runs in parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  lint-php:
    name: ğŸ˜ PHP Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/backend
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
      - run: composer install --quiet
      - run: vendor/bin/pint --test

  lint-typescript:
    name: ğŸ”· TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npx vue-tsc --noEmit

  lint-eslint:
    name: ğŸŸ¨ ESLint Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npx eslint "src/**/*.{ts,vue}" --max-warnings=0

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª STAGE 2: TESTS (after lint passes)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test-backend:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: [lint-php]
    defaults:
      run:
        working-directory: portal/backend
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          coverage: xdebug
      - run: composer install
      - run: cp .env.testing .env
      - run: php artisan key:generate
      - run: mkdir -p coverage && vendor/bin/pest --coverage-clover=coverage/clover.xml
      - uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: portal/backend/coverage/clover.xml
          flags: php
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: backend-coverage
          path: portal/backend/coverage/clover.xml
          if-no-files-found: warn

  test-frontend:
    name: ğŸ§ª Frontend Tests
    runs-on: ubuntu-latest
    needs: [lint-typescript, lint-eslint]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run test -- --coverage
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./portal/frontend/coverage/lcov.info
          flags: typescript
      - uses: actions/upload-artifact@v6
        with:
          name: frontend-coverage
          path: portal/frontend/coverage/lcov.info

  test-python:
    name: ğŸ Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install -r data-importer/scripts/requirements.txt
      - name: Run Python tests with coverage
        working-directory: data-importer/scripts
        run: pytest tests/ --cov=. --cov-report=xml -v
      - name: Fix coverage paths for SonarCloud
        run: |
          # Replace absolute source path with relative path
          sed -i 's|<source>.*/data-importer/scripts</source>|<source>data-importer/scripts</source>|g' data-importer/scripts/coverage.xml
          # Prefix filenames with the relative path
          sed -i 's|filename="|filename="data-importer/scripts/|g' data-importer/scripts/coverage.xml
          cat data-importer/scripts/coverage.xml | head -20
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: data-importer/scripts/coverage.xml
          flags: python
      - uses: actions/upload-artifact@v6
        with:
          name: python-coverage
          path: data-importer/scripts/coverage.xml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”¨ STAGE 3: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build-frontend:
    name: ğŸ”¨ Build Frontend
    runs-on: ubuntu-latest
    needs: [test-frontend]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json
      - run: npm ci
      - run: npm run build
        env:
          VITE_API_BASE_URL: https://solyx.gg/karting/api/public/api
      - uses: actions/upload-artifact@v6
        with:
          name: frontend-dist
          path: portal/frontend/dist/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š STAGE 4: SONARCLOUD ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  sonarcloud:
    name: ğŸ“Š SonarCloud
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-python]
    if: always() && !cancelled()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: portal/backend/coverage/
        continue-on-error: true
      - uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: portal/frontend/coverage/
        continue-on-error: true
      - uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: data-importer/scripts/
        continue-on-error: true
      - name: Verify Coverage Files
        run: |
          echo "### ğŸ“Š Coverage Files" >> $GITHUB_STEP_SUMMARY
          [ -f portal/backend/coverage/clover.xml ] && echo "âœ… PHP Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ PHP Coverage missing" >> $GITHUB_STEP_SUMMARY
          [ -f portal/frontend/coverage/lcov.info ] && echo "âœ… Frontend Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ Frontend Coverage missing" >> $GITHUB_STEP_SUMMARY
          [ -f data-importer/scripts/coverage.xml ] && echo "âœ… Python Coverage" >> $GITHUB_STEP_SUMMARY || echo "âŒ Python Coverage missing" >> $GITHUB_STEP_SUMMARY
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âœ… STAGE 5: QUALITY GATE - DECISION POINT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [lint-php, lint-typescript, lint-eslint, test-backend, test-frontend, build-frontend, sonarcloud]
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check Results
        id: check
        run: |
          FAILED=0
          
          # Check critical jobs (not SonarCloud - it's advisory)
          [ "${{ needs.lint-php.result }}" != "success" ] && FAILED=1
          [ "${{ needs.lint-typescript.result }}" != "success" ] && FAILED=1
          [ "${{ needs.lint-eslint.result }}" != "success" ] && FAILED=1
          [ "${{ needs.test-backend.result }}" != "success" ] && FAILED=1
          [ "${{ needs.test-frontend.result }}" != "success" ] && FAILED=1
          [ "${{ needs.build-frontend.result }}" != "success" ] && FAILED=1
          
          if [ $FAILED -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "### âœ… All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ready for deployment (if on main branch)." >> $GITHUB_STEP_SUMMARY
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "### âŒ Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Auto-fix will attempt to resolve issues..." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Summary table
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Lint | ${{ needs.lint-php.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.lint-typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.lint-eslint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.test-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.test-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”§ AUTO-FIX (ONLY on failure, runs and re-triggers pipeline)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  auto-fix:
    name: ğŸ”§ Auto-Fix
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: needs.quality-gate.outputs.passed == 'false' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check Fix Attempts
        id: attempts
        run: |
          COUNT=$(git log --oneline -20 | grep -c "ğŸ”§ Auto-fix" || echo 0)
          echo "attempts=$COUNT" >> $GITHUB_OUTPUT
          if [ $COUNT -ge ${{ env.MAX_FIX_ATTEMPTS }} ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Max Auto-Fix Attempts Reached" >> $GITHUB_STEP_SUMMARY
            echo "Reached ${{ env.MAX_FIX_ATTEMPTS }} attempts. Manual fix required." >> $GITHUB_STEP_SUMMARY
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "### ğŸ”§ Attempting Auto-Fix (Attempt $((COUNT + 1))/${{ env.MAX_FIX_ATTEMPTS }})" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Tools
        if: steps.attempts.outputs.skip != 'true'
        run: |
          # PHP
          sudo apt-get update && sudo apt-get install -y php8.2-cli php8.2-xml php8.2-curl
          cd portal/backend && composer install --quiet
          
          # Node
          cd ../frontend && npm ci --silent
          
          # Python
          pip install black autopep8 --quiet

      - name: Apply Fixes
        if: steps.attempts.outputs.skip != 'true'
        id: fix
        run: |
          FIXED=false
          
          # PHP - Laravel Pint
          echo "ğŸ”§ Running PHP Pint..."
          cd portal/backend
          vendor/bin/pint --quiet 2>/dev/null || true
          cd ../..
          
          # TypeScript/Vue - ESLint
          echo "ğŸ”§ Running ESLint fix..."
          cd portal/frontend
          npx eslint --fix "src/**/*.{ts,vue}" 2>/dev/null || true
          cd ../..
          
          # Python - Black
          echo "ğŸ”§ Running Black..."
          cd data-importer/scripts
          black . --quiet 2>/dev/null || true
          autopep8 --in-place --recursive . 2>/dev/null || true
          cd ../..
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected! Will commit and re-run pipeline." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No auto-fixable changes found. Manual fix may be required." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit & Push Fixes (Re-triggers Pipeline)
        if: steps.fix.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ğŸ”§ Auto-fix: code style corrections"
          git push
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Fixes Committed" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline will re-run automatically with the fixes applied." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If the new run passes, deployment will proceed." >> $GITHUB_STEP_SUMMARY

      - name: Create Issue (Max Attempts Reached)
        if: steps.attempts.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            if (!issues.data.find(i => i.title.includes('CI Failed'))) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”´ CI Failed - Manual Fix Required',
                body: `## Auto-fix attempts exhausted\n\nThe pipeline has failed and automatic fixes could not resolve the issues after ${process.env.MAX_FIX_ATTEMPTS} attempts.\n\n### Action Required\nPlease manually fix the issues and push a new commit.\n\n### Failed Run\n${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
                labels: ['ci-failure', 'bug']
              });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ DEPLOY (ONLY on success + main branch)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gate, build-frontend]
    if: needs.quality-gate.outputs.passed == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: portal/frontend/dist/

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Prepare Backend
        run: |
          cd portal/backend
          composer install --no-dev --optimize-autoloader

      - name: Package for Deploy
        run: |
          mkdir deploy
          cp -r portal/frontend/dist/* deploy/
          [ -f portal/frontend/.htaccess ] && cp portal/frontend/.htaccess deploy/
          mkdir deploy/api
          cp -r portal/backend/* deploy/api/
          rm -rf deploy/api/.env deploy/api/.git* deploy/api/tests

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /public_html/karting/

      - name: Run Migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 21098
          script: |
            cd ~/public_html/karting/api
            
            # Find PHP 8.2
            PHP_BIN=$(command -v php82 || command -v php || echo "php")
            
            # Create .env
            cat > .env << EOF
            APP_NAME="Karting Portal"
            APP_ENV=production
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL }}
            DB_CONNECTION=mysql
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=3306
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            SESSION_DRIVER=database
            CACHE_STORE=database
            SANCTUM_STATEFUL_DOMAINS=${{ secrets.SANCTUM_DOMAINS }}
            EOF
            
            chmod 644 .env
            chmod -R 755 storage bootstrap/cache 2>/dev/null || true
            
            $PHP_BIN artisan migrate --force
            $PHP_BIN artisan config:cache
            $PHP_BIN artisan route:cache
            
            echo "âœ… Deployment complete!"

      - name: Success Summary
        run: |
          echo "### ğŸ‰ Deployed to Production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ secrets.APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Migrations and caching completed successfully." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ‰ CLOSE ISSUES (ONLY after successful deploy)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  close-issues:
    name: ğŸ‰ Close CI Issues
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'ğŸ‰ CI Pipeline passed and deployed successfully! Closing automatically.'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
            
            core.summary
              .addHeading('ğŸ‰ CI Issues Closed', 3)
              .addRaw(`Closed ${issues.data.length} CI failure issue(s).`)
              .write();
