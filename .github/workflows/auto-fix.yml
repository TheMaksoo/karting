name: ü§ñ Auto-Fix with Copilot

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

env:
  MAX_FIX_ATTEMPTS: 3

jobs:
  # ==========================================
  # Attempt to fix failures with Copilot
  # ==========================================
  auto-fix:
    name: üîß Auto-Fix Attempt
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üî¢ Check fix attempt count
        id: check-attempts
        run: |
          # Count recent fix commits to prevent infinite loops
          FIX_COMMITS=$(git log --oneline -20 --grep="ü§ñ Auto-fix:" | wc -l)
          echo "fix_attempts=$FIX_COMMITS" >> $GITHUB_OUTPUT
          
          if [ "$FIX_COMMITS" -ge "${{ env.MAX_FIX_ATTEMPTS }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Max fix attempts (${{ env.MAX_FIX_ATTEMPTS }}) reached. Manual intervention required."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Download failure artifacts
        if: steps.check-attempts.outputs.skip != 'true'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts
        continue-on-error: true

      - name: üìã Extract errors
        if: steps.check-attempts.outputs.skip != 'true'
        id: extract-errors
        run: |
          ERRORS=""
          
          # Backend test errors
          if [ -f artifacts/backend-test-results/test-output.txt ]; then
            echo "### Backend Test Errors:" >> errors.txt
            cat artifacts/backend-test-results/test-output.txt >> errors.txt
            echo "" >> errors.txt
          fi
          
          # Frontend test errors
          if [ -f artifacts/frontend-test-results/test-output.txt ]; then
            echo "### Frontend Test Errors:" >> errors.txt
            cat artifacts/frontend-test-results/test-output.txt >> errors.txt
            echo "" >> errors.txt
          fi
          
          # TypeScript errors
          if [ -f artifacts/frontend-lint-results/typecheck-output.txt ]; then
            echo "### TypeScript Errors:" >> errors.txt
            cat artifacts/frontend-lint-results/typecheck-output.txt >> errors.txt
            echo "" >> errors.txt
          fi
          
          # Python test errors
          if [ -f artifacts/python-test-results/test-output.txt ]; then
            echo "### Python Test Errors:" >> errors.txt
            cat artifacts/python-test-results/test-output.txt >> errors.txt
            echo "" >> errors.txt
          fi
          
          if [ -f errors.txt ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "Errors found:"
            cat errors.txt
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "No error artifacts found"
          fi

      - name: üêò Setup PHP
        if: steps.extract-errors.outputs.has_errors == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: üì¶ Setup Node
        if: steps.extract-errors.outputs.has_errors == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üêç Setup Python
        if: steps.extract-errors.outputs.has_errors == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üîß Attempt Auto-Fixes
        if: steps.extract-errors.outputs.has_errors == 'true'
        id: auto-fix
        run: |
          FIXED=false
          
          # ========================================
          # Fix 1: Laravel Pint (PHP code style)
          # ========================================
          if grep -q "Pint\|pint\|code style" errors.txt 2>/dev/null; then
            echo "üîß Running Laravel Pint auto-fix..."
            cd portal/backend
            composer install --quiet
            vendor/bin/pint
            cd ../..
            FIXED=true
          fi
          
          # ========================================
          # Fix 2: ESLint (JS/TS code style)
          # ========================================
          if grep -q "eslint\|ESLint\|Parsing error" errors.txt 2>/dev/null; then
            echo "üîß Running ESLint auto-fix..."
            cd portal/frontend
            npm ci --silent
            npm run lint -- --fix || true
            cd ../..
            FIXED=true
          fi
          
          # ========================================
          # Fix 3: TypeScript errors - common patterns
          # ========================================
          if grep -q "error TS\|Type error" errors.txt 2>/dev/null; then
            echo "üîß Attempting TypeScript fixes..."
            
            # Fix missing imports
            if grep -q "Cannot find name" errors.txt; then
              echo "Detected missing imports - attempting fix..."
            fi
            
            # Run type check to see current status
            cd portal/frontend
            npm ci --silent
            npm run type-check 2>&1 || true
            cd ../..
          fi
          
          # ========================================
          # Fix 4: Python black/autopep8
          # ========================================
          if grep -q "flake8\|black\|pep8\|E501\|W503" errors.txt 2>/dev/null; then
            echo "üîß Running Python auto-formatters..."
            cd data-importer/scripts
            pip install black autopep8 --quiet
            black . --quiet || true
            autopep8 --in-place --recursive . || true
            cd ../..
            FIXED=true
          fi
          
          echo "fixed=$FIXED" >> $GITHUB_OUTPUT

      - name: üìù Check for changes
        if: steps.extract-errors.outputs.has_errors == 'true'
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No auto-fixable changes detected"
          fi

      - name: üíæ Commit and push fixes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "ü§ñ Auto-fix: code style and formatting

          Automated fixes applied:
          - Code style corrections (Pint/ESLint/Black)
          - Formatting adjustments
          
          Triggered by failed CI run: ${{ github.event.workflow_run.html_url }}"
          
          git push

      - name: üìä Generate Summary
        if: always()
        run: |
          echo "## ü§ñ Auto-Fix Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-attempts.outputs.skip }}" == "true" ]; then
            echo "‚ö†Ô∏è **Max fix attempts reached (${{ env.MAX_FIX_ATTEMPTS }})**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Manual intervention required. Please fix the errors locally." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ **Fixes applied and pushed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A new CI run will be triggered automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **No automatic fixes available**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The errors require manual intervention. See details below:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f errors.txt ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -100 errors.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: üêõ Create issue if manual fix needed
        if: steps.check-changes.outputs.has_changes != 'true' && steps.extract-errors.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errors = '';
            try {
              errors = fs.readFileSync('errors.txt', 'utf8');
            } catch (e) {
              errors = 'Error details not available';
            }
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            const title = 'üî¥ CI Failed - Manual Fix Required';
            const body = `## CI Pipeline Failed
            
            **Commit:** \`${{ github.event.workflow_run.head_sha }}\`
            **Branch:** \`${{ github.event.workflow_run.head_branch }}\`
            **Run:** ${{ github.event.workflow_run.html_url }}
            
            Auto-fix was attempted but could not resolve all issues.
            
            ## Error Details
            
            \`\`\`
            ${errors.substring(0, 60000)}
            \`\`\`
            
            ## How to Fix
            
            1. **Copy the errors above**
            2. **Open VS Code with Copilot**
            3. **Paste to Copilot Chat:** "Fix these errors: <paste>"
            4. **Push your fixes**
            
            The CI will automatically re-run when you push.`;
            
            const existingIssue = issues.data.find(i => i.title.includes('CI Failed'));
            
            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'bug']
              });
              console.log('Created new issue');
            }

  # ==========================================
  # Close issues when CI passes
  # ==========================================
  close-on-success:
    name: ‚úÖ Close Issues on Success
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: üéâ Close CI failure issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `üéâ **CI Pipeline Passed!**\n\nRun: ${{ github.event.workflow_run.html_url }}`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              console.log(`Closed issue #${issue.number}`);
            }

      - name: üìä Success Summary
        run: |
          echo "## ‚úÖ CI Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed. Deployment will proceed." >> $GITHUB_STEP_SUMMARY
