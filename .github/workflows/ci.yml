# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                         ðŸŽï¸ KARTING DASHBOARD CI/CD                          â•‘
# â•‘              Fully Automated Pipeline with Pattern-Based Auto-Fix           â•‘
# â•‘                                                                              â•‘
# â•‘  Flow: Code â†’ Test â†’ Fail? â†’ Auto-Fix â†’ Retry â†’ SonarCloud â†’ Deploy        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ðŸ”„ WORKFLOW CHAIN:
#   1. This workflow (CI/CD Pipeline) runs tests and sends to SonarCloud
#   2. On failure â†’ auto-fix.yml attempts automated fixes (Pint/ESLint/Black + patterns)
#   3. On success â†’ auto-deploy.yml deploys to Namecheap
#   4. codeql.yml â†’ Security scanning with Copilot Autofix suggestions
#
# ðŸ”‘ REQUIRED SECRETS:
#   - SONAR_TOKEN: SonarCloud authentication
#   - FTP_SERVER, FTP_USERNAME, FTP_PASSWORD: Namecheap FTP
#   - SSH_HOST, SSH_USERNAME, SSH_PRIVATE_KEY: Namecheap SSH
#   - APP_KEY, APP_URL, DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD
#   - SANCTUM_DOMAINS: Your domain for auth

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ ðŸ” STATIC ANALYSIS - Linting & Type Checking                                â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  php-lint:
    name: ðŸ˜ PHP Code Style
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/backend
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: ðŸ“¦ Install Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ðŸ” Laravel Pint
        run: vendor/bin/pint --test

  typescript-check:
    name: ðŸ“˜ TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ” Type Check
        run: npm run type-check 2>&1 | tee typecheck-output.txt

      - name: ðŸ“Š Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-lint-results
          path: portal/frontend/typecheck-output.txt
          retention-days: 7

  eslint-check:
    name: ðŸŸ¨ ESLint Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ” ESLint
        run: npm run lint 2>&1 | tee lint-output.txt

      - name: ðŸ“Š Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: portal/frontend/lint-output.txt
          retention-days: 7

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ ðŸ§ª UNIT & INTEGRATION TESTS                                                 â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  php-tests:
    name: ðŸ˜ PHP Tests (Pest)
    runs-on: ubuntu-latest
    needs: [php-lint]
    defaults:
      run:
        working-directory: portal/backend
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          --health-start-period=30s

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_mysql, mbstring, xml, curl, zip
          coverage: xdebug
          tools: composer:v2

      - name: ðŸ“¦ Install Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ðŸ”§ Setup Environment
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: â³ Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ppassword --silent 2>/dev/null; then
              echo "âœ… MySQL is ready"
              exit 0
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done
          echo "âŒ MySQL failed to start"
          exit 1

      - name: ðŸ—„ï¸ Run Migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan migrate --force

      - name: ðŸ§ª Run Tests with Coverage
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          mkdir -p coverage
          vendor/bin/pest --coverage --coverage-clover=coverage/clover.xml --log-junit=test-results.xml 2>&1 | tee test-output.txt

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./portal/backend/coverage/clover.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: ðŸ“Š Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            portal/backend/coverage/
            portal/backend/test-results.xml
            portal/backend/test-output.txt
          retention-days: 7

  frontend-tests:
    name: ðŸŽ¨ Frontend Tests (Vitest)
    runs-on: ubuntu-latest
    needs: [typescript-check, eslint-check]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§ª Run Tests with Coverage
        run: |
          mkdir -p coverage
          npm run test:coverage -- --run 2>&1 | tee test-output.txt
        continue-on-error: false

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./portal/frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: ðŸ“Š Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            portal/frontend/coverage/
            portal/frontend/test-output.txt
          retention-days: 7

  frontend-build:
    name: ðŸ”¨ Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    defaults:
      run:
        working-directory: portal/frontend
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”¨ Build
        run: npm run build
        env:
          VITE_API_BASE_URL: https://solyx.gg/karting/api/public/api

      - name: ðŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: portal/frontend/dist/
          retention-days: 7

  python-tests:
    name: ðŸ Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: data-importer/scripts
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov requests python-dateutil

      - name: ðŸ§ª Run Tests
        run: |
          python -m pytest --cov=. --cov-report=xml:coverage.xml --cov-report=term -v 2>&1 | tee test-output.txt || true

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./data-importer/scripts/coverage.xml
          flags: python
          name: python-coverage
          fail_ci_if_error: false

      - name: ðŸ“Š Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-test-results
          path: |
            data-importer/scripts/coverage.xml
            data-importer/scripts/test-output.txt
          retention-days: 7

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ ðŸ“Š SONARCLOUD ANALYSIS                                                       â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  sonarcloud:
    name: ðŸ“Š SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [php-tests, frontend-tests, python-tests]
    if: always() && !cancelled()
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Backend Coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-test-results
          path: portal/backend/
        continue-on-error: true

      - name: ðŸ“¥ Download Frontend Coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-test-results
          path: portal/frontend/
        continue-on-error: true

      - name: ðŸ“¥ Download Python Coverage
        uses: actions/download-artifact@v4
        with:
          name: python-test-results
          path: data-importer/scripts/
        continue-on-error: true

      - name: ðŸ“‚ Debug Coverage Files
        run: |
          echo "### Coverage Files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find . -name "clover.xml" -o -name "lcov.info" -o -name "coverage.xml" 2>/dev/null >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # List coverage file contents to verify they exist
          echo "### Coverage File Locations:"
          ls -la portal/backend/coverage/ 2>/dev/null || echo "No backend coverage dir"
          ls -la portal/frontend/coverage/ 2>/dev/null || echo "No frontend coverage dir"
          ls -la data-importer/scripts/ 2>/dev/null | grep coverage || echo "No python coverage"

      - name: ðŸ” SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ âœ… QUALITY GATE - Final Check Before Deploy                                  â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [php-lint, typescript-check, eslint-check, php-tests, frontend-tests, frontend-build, python-tests, sonarcloud]
    if: always()
    steps:
      - name: ðŸš¦ Evaluate Results
        run: |
          echo "## ðŸŽï¸ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          FAILED=0
          
          # PHP Lint
          if [ "${{ needs.php-lint.result }}" = "success" ]; then
            echo "| ðŸ˜ PHP Lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ˜ PHP Lint | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # TypeScript Check
          if [ "${{ needs.typescript-check.result }}" = "success" ]; then
            echo "| ðŸ“˜ TypeScript | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“˜ TypeScript | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # ESLint Check
          if [ "${{ needs.eslint-check.result }}" = "success" ]; then
            echo "| ðŸŸ¨ ESLint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŸ¨ ESLint | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # PHP Tests
          if [ "${{ needs.php-tests.result }}" = "success" ]; then
            echo "| ðŸ§ª PHP Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª PHP Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # Frontend Tests
          if [ "${{ needs.frontend-tests.result }}" = "success" ]; then
            echo "| ðŸŽ¨ Frontend Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ¨ Frontend Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # Frontend Build
          if [ "${{ needs.frontend-build.result }}" = "success" ]; then
            echo "| ðŸ”¨ Frontend Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”¨ Frontend Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # SonarCloud (informational)
          if [ "${{ needs.sonarcloud.result }}" = "success" ]; then
            echo "| ðŸ“Š SonarCloud | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“Š SonarCloud | âš ï¸ Check Dashboard |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Python Tests (non-blocking)
          if [ "${{ needs.python-tests.result }}" = "success" ]; then
            echo "| ðŸ Python Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ Python Tests | âš ï¸ Warning |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED -eq 0 ]; then
            echo "### ðŸŽ‰ All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Ready for deployment. Auto-deploy will run next." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ¤– Auto-fix workflow will attempt to resolve issues..." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
