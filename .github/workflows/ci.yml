name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # 1ï¸âƒ£ Backend Lint (Laravel Pint)
  # ==========================================
  backend-lint:
    name: 1ï¸âƒ£ PHP Lint (Pint)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: portal/backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ðŸ“¦ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('portal/backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ðŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: ðŸ” Run Laravel Pint
        run: vendor/bin/pint --test

  # ==========================================
  # 2ï¸âƒ£ Backend Tests (Laravel/Pest)
  # ==========================================
  backend-tests:
    name: 2ï¸âƒ£ PHP Tests (Pest)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: portal/backend

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP with Xdebug
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, sqlite3
          coverage: xdebug

      - name: ðŸ“¦ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('portal/backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ðŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: ðŸ”§ Setup environment
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: ðŸ—„ï¸ Run migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan migrate --force

      - name: ðŸ§ª Run Pest tests with coverage
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          vendor/bin/pest --coverage --coverage-clover=coverage/clover.xml --log-junit=test-results.xml 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $TEST_EXIT_CODE

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            portal/backend/test-output.txt
            portal/backend/test-results.xml
            portal/backend/coverage/

      - name: ðŸ“ˆ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: portal/backend/coverage/clover.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # ==========================================
  # 3ï¸âƒ£ Frontend Type Check (Vue/TypeScript)
  # ==========================================
  frontend-typecheck:
    name: 3ï¸âƒ£ TypeScript Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: portal/frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run TypeScript type check
        run: npm run type-check 2>&1 | tee typecheck-output.txt

      - name: ðŸ“Š Upload type check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-typecheck-results
          path: portal/frontend/typecheck-output.txt

  # ==========================================
  # 4ï¸âƒ£ Frontend Lint (ESLint)
  # ==========================================
  frontend-lint:
    name: 4ï¸âƒ£ ESLint Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: portal/frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint 2>&1 | tee lint-output.txt

      - name: ðŸ“Š Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-lint-results
          path: portal/frontend/lint-output.txt

  # ==========================================
  # 5ï¸âƒ£ Frontend Tests (Vitest)
  # ==========================================
  frontend-tests:
    name: 5ï¸âƒ£ Vue/TS Tests (Vitest)
    runs-on: ubuntu-latest
    needs: [frontend-typecheck]

    defaults:
      run:
        working-directory: portal/frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run tests with coverage
        run: npm run test:coverage 2>&1 | tee test-output.txt

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            portal/frontend/test-output.txt
            portal/frontend/coverage/

      - name: ðŸ“ˆ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: portal/frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # ==========================================
  # 6ï¸âƒ£ Python Tests (pytest)
  # ==========================================
  python-tests:
    name: 6ï¸âƒ£ Python Tests (pytest)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: data-importer/scripts

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: data-importer/scripts/requirements.txt

      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ðŸ§ª Run pytest with coverage
        run: |
          pytest --cov=. --cov-report=xml:coverage.xml --cov-report=term-missing --junitxml=test-results.xml 2>&1 | tee test-output.txt
        continue-on-error: true

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-test-results
          path: |
            data-importer/scripts/test-output.txt
            data-importer/scripts/test-results.xml
            data-importer/scripts/coverage.xml

      - name: ðŸ“ˆ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: data-importer/scripts/coverage.xml
          flags: python
          name: python-coverage
          fail_ci_if_error: false

  # ==========================================
  # 7ï¸âƒ£ Frontend Build
  # ==========================================
  frontend-build:
    name: 7ï¸âƒ£ Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-typecheck, frontend-lint, frontend-tests]

    defaults:
      run:
        working-directory: portal/frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: portal/frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Build production bundle
        run: npm run build

      - name: ðŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: portal/frontend/dist

  # ==========================================
  # 8ï¸âƒ£ SonarCloud Analysis
  # ==========================================
  sonarcloud:
    name: 8ï¸âƒ£ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, python-tests]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download test artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: ðŸ“‹ Prepare coverage reports
        run: |
          mkdir -p portal/backend/coverage
          mkdir -p portal/frontend/coverage
          mkdir -p data-importer/scripts
          
          if [ -f artifacts/backend-test-results/coverage/clover.xml ]; then
            cp artifacts/backend-test-results/coverage/clover.xml portal/backend/coverage/
            echo "âœ… Backend coverage: $(grep -o 'statements="[^"]*"' portal/backend/coverage/clover.xml | head -1 || echo 'found')"
          else
            echo "âš ï¸ No backend coverage found"
          fi
          
          if [ -f artifacts/frontend-test-results/coverage/lcov.info ]; then
            cp artifacts/frontend-test-results/coverage/lcov.info portal/frontend/coverage/
            echo "âœ… Frontend coverage found"
          else
            echo "âš ï¸ No frontend coverage found"
          fi
          
          if [ -f artifacts/python-test-results/coverage.xml ]; then
            cp artifacts/python-test-results/coverage.xml data-importer/scripts/
            echo "âœ… Python coverage found"
          else
            echo "âš ï¸ No Python coverage found"
          fi

      - name: ðŸ” Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================
  # 9ï¸âƒ£ Quality Gate Check
  # ==========================================
  quality-gate:
    name: 9ï¸âƒ£ Quality Gate
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-tests, frontend-typecheck, frontend-lint, frontend-tests, frontend-build, python-tests]
    if: always()
    
    steps:
      - name: ðŸš¦ Check all jobs passed
        run: |
          echo "## ðŸ§ª Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          FAILED=0
          
          # Check each job
          if [ "${{ needs.backend-lint.result }}" = "success" ]; then
            echo "âœ… PHP Lint (Pint)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ PHP Lint (Pint): ${{ needs.backend-lint.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          if [ "${{ needs.backend-tests.result }}" = "success" ]; then
            echo "âœ… PHP Tests (Pest)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ PHP Tests (Pest): ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          if [ "${{ needs.frontend-typecheck.result }}" = "success" ]; then
            echo "âœ… TypeScript Check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ TypeScript Check: ${{ needs.frontend-typecheck.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          if [ "${{ needs.frontend-lint.result }}" = "success" ]; then
            echo "âœ… ESLint Check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ESLint Check: ${{ needs.frontend-lint.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          if [ "${{ needs.frontend-tests.result }}" = "success" ]; then
            echo "âœ… Vue/TS Tests (Vitest)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Vue/TS Tests (Vitest): ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          if [ "${{ needs.frontend-build.result }}" = "success" ]; then
            echo "âœ… Frontend Build" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Frontend Build: ${{ needs.frontend-build.result }}" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
          
          # Python tests are optional
          if [ "${{ needs.python-tests.result }}" = "success" ]; then
            echo "âœ… Python Tests" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Python Tests: ${{ needs.python-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED -eq 0 ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All quality gates passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Quality gate failed - check the failing jobs above**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ==========================================
  # ðŸ“‹ Auto-Report Failures to GitHub Issue
  # ==========================================
  report-failures:
    name: ðŸ“‹ Report Failures
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: failure() && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: ðŸ“ Create failure report
        id: create-report
        run: |
          REPORT_FILE="failure-report.md"
          
          echo "# ðŸ”´ CI Pipeline Failed" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Commit:** \`${{ github.sha }}\`" >> $REPORT_FILE
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $REPORT_FILE
          echo "**Run:** [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $REPORT_FILE
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## ðŸ“‹ Error Details" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "Copy everything below and paste to GitHub Copilot for automatic fixes:" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          
          # Collect all error outputs
          for file in artifacts/*/test-output.txt artifacts/*/typecheck-output.txt artifacts/*/lint-output.txt; do
            if [ -f "$file" ]; then
              echo "" >> $REPORT_FILE
              echo "=== ${file#artifacts/} ===" >> $REPORT_FILE
              # Only include last 100 lines to keep it manageable
              tail -100 "$file" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
            fi
          done
          
          echo '```' >> $REPORT_FILE
          
          # Set output for next step
          echo "report_path=$REPORT_FILE" >> $GITHUB_OUTPUT
          
          cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Upload failure report
        uses: actions/upload-artifact@v4
        with:
          name: failure-report
          path: failure-report.md
